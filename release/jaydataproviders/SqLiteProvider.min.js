// JayData 1.3.6
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.Class.define("$data.dbClient.DbCommand",null,null,{connection:{},parameters:{},execute:function(){Guard.raise("Pure class")}},null);$data.Class.define("$data.dbClient.DbConnection",null,null,{connectionParams:{},database:{},isOpen:function(){Guard.raise("Pure class")},open:function(){Guard.raise("Pure class")},close:function(){Guard.raise("Pure class")},createCommand:function(){Guard.raise("Pure class")}},null);
$data.Class.define("$data.dbClient.openDatabaseClient.OpenDbCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a,b,c){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error,b,c)},executeQuery:function(a,b,c){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error,b,c)},exec:function(a,b,c,d,e,g){this.connection.open({error:d,
success:function(g){function h(){0==--l&&c(i?j[0]:j,e)}var i=!1;a instanceof Array||(i=!0,a=[a],b=[b]);var j=[],l=0;a.forEach(function(c,e){l++;if(c)g.executeSql(a[e],b[e],function(a,b){var c={rows:[]};try{c.insertId=b.insertId}catch(d){}if(typeof c.insertId!=="number"){c.rowsAffected=b.rowsAffected;for(var g=b.rows.length,f=0;f<g;f++)c.rows.push(b.rows.item(f))}j[e]=c;h(a)},function(a,b){d&&d(b);return true});else{j[e]=null;h()}})}},e,g)}},null);
$data.Class.define("$data.dbClient.openDatabaseClient.OpenDbConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return null!==this.database&&void 0!==this.database&&null!==this.transaction&&void 0!==this.transaction},open:function(a,b,c){void 0===c&&(c=!0);a.oncomplete=a.oncomplete||function(){};if(b)a.success(b.transaction);else{if(!this.database){var b=this.connectionParams,d=this;this.database=openDatabase(b.fileName,b.version,b.displayName,
b.maxSize);this.database.readTransaction||(this.database.readTransaction=function(){d.database.transaction.apply(d.database,arguments)})}c?this.database.transaction(function(b){a.success(b)},a.error,a.oncomplete):this.database.readTransaction(function(b){a.success(b)},a.error,a.oncomplete)}},close:function(){this.database=this.transaction=void 0},createCommand:function(a,b){return new $data.dbClient.openDatabaseClient.OpenDbCommand(this,a,b)}},null);
$data.Class.define("$data.dbClient.jayStorageClient.JayStorageCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},executeQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},exec:function(a,b,c,d){if(null==b||void 0==b)b={};var e=!1;a instanceof
Array||(e=!0,a=[a],b=[b]);var g=[],f=a.length,h=function(){--f==0&&c(e?g[0]:g)};a.forEach(function(a,c){if(a)$data.ajax({url:"http"+(this.connection.connectionParams.storage.ssl?"s":"")+"://"+this.connection.connectionParams.storage.src.replace("http://","").replace("https://","")+"?db="+this.connection.connectionParams.storage.key,type:"POST",headers:{"X-PINGOTHER":"pingpong"},data:{query:a,parameters:b[c]},dataType:"json",contentType:"application/json;charset=UTF-8",success:function(a){if(a&&a.error){console.log("JayStorage error",
a.error);d(a.error)}else{g[c]=this.lastID?{insertId:this.lastID,rows:(a||{rows:[]}).rows}:{rows:(a||{rows:[]}).rows};h()}}});else{g[c]=null;h()}},this)}},null);$data.Class.define("$data.dbClient.jayStorageClient.JayStorageConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return!0},open:function(){},close:function(){},createCommand:function(a,b){return new $data.dbClient.jayStorageClient.JayStorageCommand(this,a,b)}},null);
$data.Class.define("$data.dbClient.sqLiteNJClient.SqLiteNjCommand",$data.dbClient.DbCommand,null,{constructor:function(a,b,c){this.query=b;this.connection=a;this.parameters=c},executeNonQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},executeQuery:function(a){a=$data.typeSystem.createCallbackSetting(a);this.exec(this.query,this.parameters,a.success,a.error)},exec:function(a,b,c,d){this.connection.isOpen()||this.connection.open();
if(null==b||void 0==b)b={};var e=!1;a instanceof Array||(e=!0,a=[a],b=[b]);var g=this,f=[],h=0,i=function(){if(--h==0){g.connection.database.exec("COMMIT");c(e?f[0]:f)}};g.connection.database.exec("BEGIN");a.forEach(function(a,c){h++;if(a){var e=function(a,b){if(a!=null)d(a);else{f[c]=this.lastID?{insertId:this.lastID,rows:[]}:{rows:b};i()}},k=g.connection.database.prepare(a,b[c]);a.indexOf("SELECT")==0?k.all(e):k.run(e);k.finalize()}else{f[c]=null;i()}},this)}},null);
$data.Class.define("$data.dbClient.sqLiteNJClient.SqLiteNjConnection",$data.dbClient.DbConnection,null,{constructor:function(a){this.connectionParams=a},isOpen:function(){return null!==this.database&&void 0!==this.database},open:function(){null==this.database&&(this.database=new sqLiteModule.Database(this.connectionParams.fileName))},close:function(){},createCommand:function(a,b){return new $data.dbClient.sqLiteNJClient.SqLiteNjCommand(this,a,b)}},null);
$data.SqLiteConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":function(a){return null!=a?new Date(a):a},"$data.DateTimeOffset":function(a){return null!=
a?new Date(a):a},"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":function(a){return 1===a?!0:!1},"$data.Blob":function(a){return a?$data.Container.convertTo(atob(a),$data.Blob):a},"$data.Array":function(){return 0==arguments.length?[]:arguments[0]?JSON.parse(arguments[0]):void 0},"$data.Guid":function(a){return a?$data.parseGuid(a).toString():a},"$data.GeographyPoint":function(a){return a?new $data.GeographyPoint(JSON.parse(a)):a},"$data.GeographyLineString":function(a){return a?
new $data.GeographyLineString(JSON.parse(a)):a},"$data.GeographyPolygon":function(a){return a?new $data.GeographyPolygon(JSON.parse(a)):a},"$data.GeographyMultiPoint":function(a){return a?new $data.GeographyMultiPoint(JSON.parse(a)):a},"$data.GeographyMultiLineString":function(a){return a?new $data.GeographyMultiLineString(JSON.parse(a)):a},"$data.GeographyMultiPolygon":function(a){return a?new $data.GeographyMultiPolygon(JSON.parse(a)):a},"$data.GeographyCollection":function(a){return a?new $data.GeographyCollection(JSON.parse(a)):
a},"$data.GeometryPoint":function(a){return a?new $data.GeometryPoint(JSON.parse(a)):a},"$data.GeometryLineString":function(a){return a?new $data.GeometryLineString(JSON.parse(a)):a},"$data.GeometryPolygon":function(a){return a?new $data.GeometryPolygon(JSON.parse(a)):a},"$data.GeometryMultiPoint":function(a){return a?new $data.GeometryMultiPoint(JSON.parse(a)):a},"$data.GeometryMultiLineString":function(a){return a?new $data.GeometryMultiLineString(JSON.parse(a)):a},"$data.GeometryMultiPolygon":function(a){return a?
new $data.GeometryMultiPolygon(JSON.parse(a)):a},"$data.GeometryCollection":function(a){return a?new $data.GeometryCollection(JSON.parse(a)):a}},toDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,
"$data.Number":$data.Container.proxyConverter,"$data.Date":function(a){return a?a.valueOf():null},"$data.DateTimeOffset":function(a){return a?a.valueOf():null},"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":function(a){return a?1:0},"$data.Blob":function(a){return a?$data.Blob.toBase64(a):a},"$data.Array":function(a){return a?JSON.stringify(a):a},"$data.Guid":function(a){return a?a.toString():a},"$data.Object":function(a){if(null===a)return null;
throw"Not supported exception";},"$data.GeographyPoint":function(a){return a?JSON.stringify(a):a},"$data.GeographyLineString":function(a){return a?JSON.stringify(a):a},"$data.GeographyPolygon":function(a){return a?JSON.stringify(a):a},"$data.GeographyMultiPoint":function(a){return a?JSON.stringify(a):a},"$data.GeographyMultiLineString":function(a){return a?JSON.stringify(a):a},"$data.GeographyMultiPolygon":function(a){return a?JSON.stringify(a):a},"$data.GeographyCollection":function(a){return a?
JSON.stringify(a):a},"$data.GeometryPoint":function(a){return a?JSON.stringify(a):a},"$data.GeometryLineString":function(a){return a?JSON.stringify(a):a},"$data.GeometryPolygon":function(a){return a?JSON.stringify(a):a},"$data.GeometryMultiPoint":function(a){return a?JSON.stringify(a):a},"$data.GeometryMultiLineString":function(a){return a?JSON.stringify(a):a},"$data.GeometryMultiPolygon":function(a){return a?JSON.stringify(a):a},"$data.GeometryCollection":function(a){return a?JSON.stringify(a):a}}};
$data.SqLiteFieldMapping={"$data.Byte":"INTEGER","$data.SByte":"INTEGER","$data.Decimal":"TEXT","$data.Float":"REAL","$data.Int16":"INTEGER","$data.Int64":"TEXT","$data.Integer":"INTEGER","$data.Int32":"INTEGER","$data.Number":"REAL","$data.Date":"REAL","$data.Time":"TEXT","$data.DateTimeOffset":"REAL","$data.String":"TEXT","$data.Boolean":"INTEGER","$data.Blob":"BLOB","$data.Array":"TEXT","$data.Guid":"TEXT","$data.Object":"TEXT","$data.GeographyPoint":"TEXT","$data.GeographyLineString":"TEXT","$data.GeographyPolygon":"TEXT",
"$data.GeographyMultiPoint":"TEXT","$data.GeographyMultiLineString":"TEXT","$data.GeographyMultiPolygon":"TEXT","$data.GeographyCollection":"TEXT","$data.GeometryPoint":"TEXT","$data.GeometryLineString":"TEXT","$data.GeometryPolygon":"TEXT","$data.GeometryMultiPoint":"TEXT","$data.GeometryMultiLineString":"TEXT","$data.GeometryMultiPolygon":"TEXT","$data.GeometryCollection":"TEXT"};
$data.Class.define("$data.storageProviders.sqLite.SqLiteStorageProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.SqlCommands=[];this.context=b;this.providerConfiguration=$data.typeSystem.extend({databaseName:$data.defaults.defaultDatabaseName,version:"",displayName:"JayData default db",maxSize:1048576,dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged},a);this.providerName="";for(var c in $data.RegisteredStorageProviders)$data.RegisteredStorageProviders[c]===
this.getType()&&(this.providerName=c);this.context&&this.context._buildDbType_generateConvertToFunction&&this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},_createSqlConnection:function(){var a={fileName:this.providerConfiguration.databaseName,
version:"",displayName:this.providerConfiguration.displayName,maxSize:this.providerConfiguration.maxSize,storage:this.providerConfiguration.storage};if(this.connection)return this.connection;var b=null;return this.connection=b=this.providerConfiguration.storage?new $data.dbClient.jayStorageClient.JayStorageConnection(a):"undefined"!==typeof sqLiteModule?new $data.dbClient.sqLiteNJClient.SqLiteNjConnection(a):new $data.dbClient.openDatabaseClient.OpenDbConnection(a)},supportedDataTypes:{value:[$data.Array,
$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.Guid,$data.GeographyPoint,$data.GeographyLineString,$data.GeographyPolygon,$data.GeographyMultiPoint,$data.GeographyMultiLineString,$data.GeographyMultiPolygon,$data.GeographyCollection,$data.GeometryPoint,$data.GeometryLineString,$data.GeometryPolygon,$data.GeometryMultiPoint,$data.GeometryMultiLineString,$data.GeometryMultiPolygon,$data.GeometryCollection,$data.Byte,$data.SByte,$data.Decimal,$data.Float,$data.Int16,
$data.Int32,$data.Int64,$data.Time,$data.DateTimeOffset],writable:!1},fieldConverter:{value:$data.SqLiteConverter},supportedFieldOperations:{value:{length:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression]},substr:{dataType:"string",allowedIn:$data.Expressions.FilterExpression,parameters:[{name:"startFrom",dataType:"number"},{name:"length",dataType:"number"}]},toLowerCase:{dataType:"string",mapTo:"lower"},toUpperCase:{dataType:"string",mapTo:"upper"},
contains:{mapTo:"like",dataType:"boolean",allowedIn:$data.Expressions.FilterExpression,parameters:[{name:"strFragment",dataType:"string",prefix:"%",suffix:"%"}]},startsWith:{mapTo:"like",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"strFragment",dataType:"string",suffix:"%"}]},endsWith:{mapTo:"like",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"strFragment",
dataType:"string",prefix:"%"}]},trim:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"trim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]},ltrim:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"ltrim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]},rtrim:{dataType:$data.String,
allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"rtrim",parameters:[{name:"@expression",dataType:$data.String},{name:"chars",dataType:$data.String}]}},enumerable:!0,writable:!0},supportedBinaryOperators:{value:{equal:{mapTo:"=",dataType:"boolean",nullMap:" is null"},notEqual:{mapTo:"!=",dataType:"boolean",nullMap:" is not null"},equalTyped:{mapTo:"=",dataType:"boolean"},notEqualTyped:{mapTo:"!=",dataType:"boolean"},greaterThan:{mapTo:">",dataType:"boolean"},
greaterThanOrEqual:{mapTo:">=",dataType:"boolean"},lessThan:{mapTo:"<",dataType:"boolean"},lessThenOrEqual:{mapTo:"<=",dataType:"boolean"},or:{mapTo:"OR",dataType:"boolean"},and:{mapTo:"AND",dataType:"boolean"},add:{mapTo:"+",dataType:"number"},divide:{mapTo:"/"},multiply:{mapTo:"*"},subtract:{mapTo:"-"},modulo:{mapTo:"%"},orBitwise:{maptTo:"|"},andBitwsise:{mapTo:"&"},"in":{mapTo:"in",dataType:"boolean"}}},supportedUnaryOperators:{value:{not:{mapTo:"not"},positive:{mapTo:"+"},negative:{maptTo:"-"}}},
supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{}},enumerable:!0,writable:!0},supportedAutoincrementKeys:{value:{"$data.Integer":!0,"$data.Int32":!0,"$data.Guid":function(){return $data.createGuid()}}},initializeStore:function(a){a=$data.typeSystem.createCallbackSetting(a);this.context._storageModel.forEach(function(a){this.SqlCommands.push(this.createSqlFromStorageModel(a)+" ")},this);var b=
this._createSqlConnection(),c=this;b.createCommand("SELECT * FROM sqlite_master WHERE type = 'table'",null).executeQuery({success:function(d){for(var e={},g=0;g<d.rows.length;g++){var f=d.rows[g];e[f.tbl_name]=f}switch(c.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.Merge:Guard.raise(new Exception("Not supported db creation type"));break;case $data.storageProviders.DbCreationType.DropTableIfChanged:d=[];for(g=0;g<c.SqlCommands.length;g++)if(""!=c.SqlCommands[g]){var h=
RegExp("^CREATE TABLE IF NOT EXISTS ([^ ]*) (\\(.*\\))","g").exec(c.SqlCommands[g]);if(h&&(f=h[1],h=h[2],e[f.slice(1,f.length-1)])){var i=RegExp("\\(.*\\)","g"),i=e[f.slice(1,f.length-1)].sql.match(i);(!i||h.toLowerCase()!=i[0].toLowerCase())&&d.push("DROP TABLE IF EXISTS ["+e[f.slice(1,f.length-1)].tbl_name+"];")}}c.SqlCommands=c.SqlCommands.concat(d);break;case $data.storageProviders.DbCreationType.DropAllExistingTables:for(h in e)h&&!h.match("^__")&&!h.match("^sqlite_")&&c.SqlCommands.push("DROP TABLE IF EXISTS ["+
e[h].tbl_name+"];")}c._runSqlCommands(b,{success:a.success,error:a.error})},error:a.error})},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),c=this._createSqlConnection(),d=this._compile(a);a.actionPack=d.actions;a.sqlConvertMetadata=d.converter;a.modelBinderConfig=d.modelBinderConfig;c.createCommand(d.sqlText,d.params).executeQuery({success:function(c){b.success&&(a.rawDataList=c.rows,b.success(a))},error:b.error})},_compile:function(a){var b=new $data.storageProviders.sqLite.SQLiteCompiler,
a=b.compile(a);a.hasSelect=null!=b.select;return a},getTraceString:function(a){return this._compile(a)},_runSqlCommands:function(a,b){if(this.SqlCommands&&0<this.SqlCommands.length){var c=this.SqlCommands.pop(),d=this;a.createCommand(c,null).executeQuery({success:function(){d._runSqlCommands.apply(d,[a,b])},error:b.error})}else b.success(this.context)},setContext:function(a){this.context=a},saveChanges:function(a,b){var c=this._createSqlConnection(),d=this.buildIndependentBlocks(b);this.saveIndependentBlocks(b,
d,c,a)},saveIndependentBlocks:function(a,b,c,d){function e(){if(0===f.length)d.success();else{var a=f.shift().map(function(a){var b=g.context._storageModel.getStorageModel(a.data.getType()).PhysicalType;a.physicalData=b.convertTo(a.data);return a},this);try{g.saveIndependentItems(a,c,{success:function(){g.postProcessItems(a);e()},error:d.error})}catch(b){d.error(b)}}}var g=this,f=[].concat(b);e()},saveIndependentItems:function(a,b,c){function d(a,b){var c=[],d=[];b.forEach(function(a,b){if(a&&(a.query&&
(c[b]=a.query),a.param))d[b]=a.param});return a.createCommand(c,d)}var e=this,g=a.map(function(a){return e.saveEntitySet(a)}),g=g.filter(function(a){return a});0===g.length?c.success(a):d(b,g).executeQuery({success:function(g){g=g.map(function(c,d){return c&&c.insertId?e.save_reloadSavedEntity(c.insertId,a[d].entitySet.tableName,b):null});g=d(b,g);0<g.query.length?g.executeQuery(function(b){b.forEach(function(b,c){b&&b.rows&&(a[c].physicalData.initData=b.rows[0])});c.success(a)}):c.success(0)},error:c.error})},
postProcessItems:function(a){function b(a){var b=a.name;if(c.hasOwnProperty(b))return c[b];a=a.memberDefinitions.getPublicMappedProperties().filter(function(a){return a.computed});return c[b]=a}var c={};a.forEach(function(a){a.physicalData&&b(a.data.getType()).forEach(function(b){a.data[b.name]=a.physicalData[b.name]},this)},this)},saveEntitySet:function(a){switch(a.data.entityState){case $data.EntityState.Added:return this.save_NewEntity(a);case $data.EntityState.Deleted:return this.save_DeleteEntity(a);
case $data.EntityState.Modified:return this.save_UpdateEntity(a);case $data.EntityState.Unchanged:break;default:Guard.raise(new Exception("Not supported entity state"))}},save_DeleteEntity:function(a){for(var b="DELETE FROM ["+a.entitySet.tableName+"] WHERE(",c=!1,d=!1,e=[];!c;)a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(g){c&&!b.match(" AND $")&&(b+=" AND ");if(g.key||d){b+="(["+g.name+"] == ?)";var f=a.data.getType().memberDefinitions.getMember(g.name);
f&&f.converter&&f.converter[this.providerName]&&"function"==typeof f.converter[this.providerName].toDb?e.push(f.converter[this.providerName].toDb(a.data[f.name],f,this.context,f.dataType)):e.push(this.fieldConverter.toDb[Container.resolveName(g.dataType)](a.data[g.name]));c=!0}},this),c||(d=!0);b.match(" AND $")&&(b=b.slice(0,b.length-5));b+=");";return{query:b,param:e}},save_UpdateEntity:function(a){var b=" SET ",c="WHERE(",d=!1,e=[],g=[];a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(f){if(void 0!==
a.physicalData[f.name])if(d&&!c.match(" AND $")&&(c+=" AND "),5<b.length&&!b.match(",$")&&(b+=","),f.key){c+="(["+f.name+"] == ?)";var h=a.data.getType().memberDefinitions.getMember(f.name);h&&h.converter&&h.converter[this.providerName]&&"function"==typeof h.converter[this.providerName].toDb?e.push(h.converter[this.providerName].toDb(a.physicalData[h.name],f,this.context,h.dataType)):e.push(this.fieldConverter.toDb[Container.resolveName(f.dataType)](a.physicalData[f.name]));d=!0}else b+="["+f.name+
"] = ?",(h=a.data.getType().memberDefinitions.getMember(f.name))&&h.converter&&h.converter[this.providerName]&&"function"==typeof h.converter[this.providerName].toDb?g.push(f.converter[this.providerName].toDb(a.physicalData[h.name],h,this.context,h.dataType)):g.push(this.fieldConverter.toDb[Container.resolveName(f.dataType)](a.physicalData[f.name]))},this);d||Guard.raise(new Exception("Not supported UPDATE function without primary key!"));c.match(" AND $")&&(c=c.slice(0,c.length-5));b.match(",$")&&
(b=b.slice(0,b.length-1));return{query:"UPDATE ["+a.entitySet.tableName+"]"+b+" "+c+");",param:g.concat(e)}},save_NewEntity:function(a){var b="INSERT INTO ["+a.entitySet.tableName+"](",c="",d="",e=[];a.physicalData.constructor.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(b.key&&!b.computed&&Object.isNullOrUndefined(a.physicalData[b.name]))Guard.raise(new Exception("Key is not set","Value exception",a));else{if(b.key&&b.computed&&Object.isNullOrUndefined(a.physicalData[b.name])){var f=
Container.resolveName(b.type);"function"===typeof this.supportedAutoincrementKeys[f]&&(a.physicalData[b.name]=this.supportedAutoincrementKeys[f]())}0<c.length&&","!=c[c.length-1]&&(c+=",",d+=",");f=b.name;if(void 0!==a.physicalData[f]&&b.dataType&&(!b.dataType.isAssignableTo||b.dataType.isAssignableTo&&!b.dataType.isAssignableTo($data.EntitySet))){d+="?";c+="["+f+"]";var h=a.data.getType().memberDefinitions.getMember(b.name);h&&h.converter&&h.converter[this.providerName]&&"function"==typeof h.converter[this.providerName].toDb?
e.push(h.converter[this.providerName].toDb(a.physicalData[f],h,this.context,h.dataType)):e.push(this.fieldConverter.toDb[Container.resolveName(b.dataType)](a.physicalData[f]))}}},this);1>e.length?b="INSERT INTO ["+a.entitySet.tableName+"] Default values":(","==c[c.length-1]&&(c=c.slice(0,c.length-1)),","==d[d.length-1]&&(d=d.slice(0,d.length-1)),b+=c+") VALUES("+d+");");return{query:b,param:e}},save_reloadSavedEntity:function(a,b){return{query:"SELECT * FROM "+b+" WHERE rowid=?",param:[a]}},createSqlFromStorageModel:function(a){(void 0===
a||null===a||void 0===a.PhysicalType)&&Guard.raise("StorageModel not contains physical entity definition");var b=0,c=0;a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){a.key&&b++;a.computed&&c++},this);1===c&&1<b&&Guard.raise(new Exception("Do not use computed field with multiple primary key!"));1<c&&1<b&&Guard.raise(new Exception("Do not use multiple computed field!"));a.PhysicalType.memberDefinitions.getKeyProperties().forEach(function(a){var b=Container.resolveName(a.type);
a.computed&&!(b in this.supportedAutoincrementKeys)&&console.log("WARRNING! '"+b+"' not supported as computed Key!")},this);var d="CREATE TABLE IF NOT EXISTS ["+a.TableName+"] (",e=",PRIMARY KEY (";a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(b,f){0<f&&!d.match(", $")&&!d.match("\\($")&&(d+=", ");d+=this.createSqlFragmentFromField(b,1===c,a);0===c&&b.key&&(14<e.length&&!e.match(", $")&&(e+=", "),e+="["+b.name+"]")},this);d.match(", $")&&(d=d.substr(0,d.length-2));
0===c&&14<e.length&&(d+=e+")");return d+=");"},createSqlFragmentFromField:function(a,b,c){return"schemaCreate"in a&&a.schemaCreate?a.schemaCreate(a):(new this.FieldTypeBuilder(a,this,b,c)).build()},FieldTypeBuilder:function(a,b,c,d){this.fieldDef="";this.fld=a;this.provider=b;this.parsePk=c;this.entitySet=d;this.build=function(){var a=Container.resolveName(this.fld.dataType);(a=$data.SqLiteFieldMapping[a])?this.buildFieldNameAndType(a):this.buildRelations();return this.fieldDef};this.buildFieldNameAndType=
function(a){this.fieldDef="["+this.fld.name+"] "+a;this.parsePk?this.buildPrimaryKey():this.buildNotNull()};this.buildPrimaryKey=function(){this.fld.key?(this.fieldDef+=" PRIMARY KEY",!0===this.provider.supportedAutoincrementKeys[Container.resolveName(this.fld.dataType)]&&this.buildAutoIncrement()):this.buildNotNull()};this.buildNotNull=function(){this.fld.required&&(this.fieldDef+=" NOT NULL")};this.buildAutoIncrement=function(){this.fld.computed&&(this.fieldDef+=" AUTOINCREMENT")}}},{isSupported:{get:function(){return"openDatabase"in
window},set:function(){}}});$data.storageProviders.sqLite.SqLiteStorageProvider.isSupported&&($data.StorageProviderBase.registerProvider("webSql",$data.storageProviders.sqLite.SqLiteStorageProvider),$data.StorageProviderBase.registerProvider("sqLite",$data.storageProviders.sqLite.SqLiteStorageProvider),$data.webSqlProvider=$data.storageProviders.sqLite.SqLiteStorageProvider);
var SqlStatementBlocks={beginGroup:"(",endGroup:")",nameSeparator:".",valueSeparator:", ",select:"SELECT ",where:" WHERE ",from:" FROM ",skip:" OFFSET ",take:" LIMIT ",parameter:"?",order:" ORDER BY ",as:" AS ",scalarFieldName:"d",rowIdName:"rowid$$",count:"select count(*) cnt from ("};$C("$data.sqLite.SqlBuilder",$data.queryBuilder,null,{constructor:function(a,b){this.sets=a;this.entityContext=b},getExpressionAlias:function(a){var b=this.sets.indexOf(a);b==-1&&(b=this.sets.push(a)-1);return"T"+b}});
$C("$data.sqLite.SqlCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this.queryExpression=a;this.sets=b.sets;this.infos=b.infos;this.entityContext=b.entityContext;this.associations=[];this.filters=[];this.newFilters={};this.sortedFilterPart=["projection","from","filter","order","take","skip"]},compile:function(){var a=$data.sqLite.SqlBuilder.create(this.sets,this.entityContext);this.Visit(this.queryExpression,a);a.getTextPart("projection")===void 0&&this.VisitDefaultProjection(a);
a.selectTextPart("result");this.sortedFilterPart.forEach(function(b){if(b=a.getTextPart(b)){a.addText(b.text);a.selectedFragment.params=a.selectedFragment.params.concat(b.params)}},this);var b=a.getTextPart("count");if(b!==void 0){a.selectedFragment.text=b.text+a.selectedFragment.text;a.addText(SqlStatementBlocks.endGroup);a.selectedFragment.params=a.selectedFragment.params.concat(b.params)}a.resetModelBinderProperty();this.filters.push(a)},VisitToArrayExpression:function(a,b){this.Visit(a.source,
b)},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("count");b.addText(SqlStatementBlocks.count)},VisitFilterExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("filter");b.addText(SqlStatementBlocks.where);$data.sqLite.SqlFilterCompiler.create().Visit(a.selector,b);return a},VisitOrderExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("order");if(this.addOrders)b.addText(SqlStatementBlocks.valueSeparator);else{this.addOrders=true;b.addText(SqlStatementBlocks.order)}$data.sqLite.SqlOrderCompiler.create().Visit(a,
b);return a},VisitPagingExpression:function(a,b){this.Visit(a.source,b);switch(a.nodeType){case $data.Expressions.ExpressionType.Skip:b.selectTextPart("skip");b.addText(SqlStatementBlocks.skip);break;case $data.Expressions.ExpressionType.Take:b.selectTextPart("take");b.addText(SqlStatementBlocks.take);break;default:Guard.raise("Not supported nodeType")}$data.sqLite.SqlPagingCompiler.create().Visit(a,b);return a},VisitProjectionExpression:function(a,b){this.Visit(a.source,b);b.selectTextPart("projection");
this.hasProjection=true;b.addText(SqlStatementBlocks.select);$data.sqLite.SqlProjectionCompiler.create().Visit(a,b)},VisitEntitySetExpression:function(a,b){b.selectTextPart("from");b.addText(SqlStatementBlocks.from);b.sets.forEach(function(a,d){d>0&&b.addText(" \n\tLEFT OUTER JOIN ");var e=b.getExpressionAlias(a);b.addText(a.instance.tableName+" ");b.addText(e);if(d>0){b.addText(" ON (");var g=this.infos[d],f="T"+g.AliasNumber,h=g.NavigationPath.substring(0,g.NavigationPath.lastIndexOf(".")),e=this.infos.filter(function(a){return a.NavigationPath==
h},this),i="T0";e.length>0&&(i="T"+e[0].AliasNumber);g.Association.associationInfo.ReferentialConstraint.forEach(function(a,c){c>0&&b.addText(" AND ");b.addText(i+"."+a[g.Association.associationInfo.From]);b.addText(" = ");b.addText(f+"."+a[g.Association.associationInfo.To])},this);b.addText(")")}},this)},VisitDefaultProjection:function(a){a.selectTextPart("projection");var b=this.infos.filter(function(a){return a.IsMapped}).length>1;if(a.sets.length>1){a.addText(SqlStatementBlocks.select);a.sets.forEach(function(c,
d){if(this.infos[d].IsMapped){var e=a.getExpressionAlias(c);c.storageModel.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(c,f){(f>0||d>0)&&a.addText(SqlStatementBlocks.valueSeparator);a.addText(e+".");a.addText(c.name);if(b){a.addText(SqlStatementBlocks.as);a.addText(e+"__"+c.name)}},this)}},this)}else a.addText("SELECT *")}});$data.Expressions.ExpressionNode.prototype.monitor=function(a,b){return $data.sqLite.SqlExpressionMonitor.create(a).Visit(this,b)};
$C("$data.storageProviders.sqLite.SQLiteCompiler",null,null,{compile:function(a){var b={sets:[],infos:[],entityContext:a.context},c=a.expression.monitor({MonitorEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityContextExpression&&b.sets.indexOf(a)==-1)this.backupEntitySetExpression=a},VisitCountExpression:function(a,b){b.hasCountFrameOperator=true;return a},MutateIncludeExpression:function(a,b){var c=null;if(b.hasCountFrameOperator)c=a.source;else{c=a.selector.value;
Container.createCodeExpression("function(it){return it."+c+";}",null);c=Container.createCodeParser(this.backupEntitySetExpression.source.instance).createExpression("function(it){return it."+c+";}");c=Container.createCodeToEntityConverter(this.backupEntitySetExpression.source.instance).Visit(c,{queryParameters:void 0,lambdaParameters:[this.backupEntitySetExpression]});c=Container.createIncludeExpression(a.source,c)}return c}},b).monitor({MonitorEntitySetExpression:function(a,b){if(a.source instanceof
$data.Expressions.EntityContextExpression&&b.sets.indexOf(a)==-1){b.sets.push(a);b.infos.push({AliasNumber:0,Association:null,FromType:null,FromPropertyName:null,IsMapped:true})}},MutateEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityContextExpression){this.backupContextExpression=a.source;this.path="";return a}a.selector.associationInfo.FromMultiplicity=="0..1"&&a.selector.associationInfo.FromMultiplicity=="*"&&Guard.raise("Not supported query on this navigation property: "+
a.selector.associationInfo.From+" "+a.selector.associationInfo.FromPropertyName);this.path=this.path+("."+a.selector.associationInfo.FromPropertyName);var c=b.infos.filter(function(a){return a.NavigationPath==this.path},this);if(c.length>0)return b.sets[c[0].AliasNumber];(c=this.backupContextExpression.instance.getType().memberDefinitions.getMember(a.storageModel.ItemName))||Guard.raise("Context schema error");c=Container.createMemberInfoExpression(c);c=Container.createEntitySetExpression(this.backupContextExpression,
c);c.instance=this.backupContextExpression.instance[a.storageModel.ItemName];var d=b.sets.push(c);b.infos.push({AliasNumber:d-1,Association:a.selector,NavigationPath:this.path,IsMapped:this.isMapped});return c}},b),d=$data.sqLite.SqlCompiler.create(c,b);d.compile();$data.sqLite.SqlBuilder.create(this.sets,this.entityContext);a.modelBinderConfig={};$data.sqLite.sqLite_ModelBinderCompiler.create(a,b).Visit(c);return{sqlText:d.filters[0].selectedFragment.text,params:d.filters[0].selectedFragment.params,
modelBinderConfig:a.modelBinderConfig}}},null);$C("$data.sqLite.SqlPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitPagingExpression:function(a,b){this.Visit(a.amount,b)},VisitConstantExpression:function(a,b){b.addParameter(a.value);b.addText(SqlStatementBlocks.parameter)}});
$C("$data.sqLite.SqlOrderCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitEntitySetExpression:function(a,b){var c=b.getExpressionAlias(a);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator)},VisitOrderExpression:function(a,b){this.Visit(a.selector,b);a.nodeType==$data.Expressions.ExpressionType.OrderByDescending?b.addText(" DESC"):b.addText(" ASC")},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,
b)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.addText("__")}});
$C("$data.sqLite.SqlProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.anonymFiledPrefix="";this.currentObjectLiteralName=null},VisitProjectionExpression:function(a,b){this.Visit(a.selector,b)},VisitParametricQueryExpression:function(a,b){if(a.expression instanceof $data.Expressions.EntityExpression){this.VisitEntitySetExpression(b.sets[0],b);b.addText("rowid AS "+this.anonymFiledPrefix+SqlStatementBlocks.rowIdName+", ");this.VisitEntityExpressionAsProjection(a,
b)}else if(a.expression instanceof $data.Expressions.EntitySetExpression){this.VisitEntitySetExpression(b.sets[0],b);b.addText("rowid AS "+this.anonymFiledPrefix+SqlStatementBlocks.rowIdName+", ");this.anonymFiledPrefix=b.getExpressionAlias(a.expression)+"__";this.MappedFullEntitySet(a.expression,b)}else if(a.expression instanceof $data.Expressions.ObjectLiteralExpression){this.VisitEntitySetExpression(b.sets[0],b);b.addText("rowid AS "+this.anonymFiledPrefix+SqlStatementBlocks.rowIdName+", ");this.Visit(a.expression,
b)}else{this.VisitEntitySetExpression(b.sets[0],b);b.addText("rowid");b.addText(SqlStatementBlocks.as);b.addText(SqlStatementBlocks.rowIdName);b.addText(", ");b.addKeyField(SqlStatementBlocks.rowIdName);this.Visit(a.expression,b);if(!(a.expression instanceof $data.Expressions.ComplexTypeExpression)){b.addText(SqlStatementBlocks.as);b.addText(SqlStatementBlocks.scalarFieldName)}}},VisitEntityExpressionAsProjection:function(a,b){var c=a.expression,d=b.getExpressionAlias(c.source),e=this.anonymFiledPrefix+
(a.fieldName?a.fieldName:""),e=e?e+"__":"";c.storageModel.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a,c){c>0&&b.addText(SqlStatementBlocks.valueSeparator);var h=e+a.name;b.addText(d);b.addText(SqlStatementBlocks.nameSeparator);b.addText(a.name);b.addText(SqlStatementBlocks.as);b.addText(h)},this)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition,
d=c.mapTo||c.name;b.addText(d);b.addText(SqlStatementBlocks.beginGroup);if(d==="like"){d=$data.sqLite.SqlBuilder.create();this.Visit(a.parameters[0],d);d.params.forEach(function(a){var d=c.parameters[0],a=d.prefix?d.prefix+a:a,a=d.suffix?a+d.suffix:a;b.addParameter(a)});b.addText(d.sql);b.addText(" , ");this.Visit(a.source,b)}else{this.Visit(a.source,b);a.parameters.forEach(function(a){b.addText(" , ");this.Visit(a,b)},this)}b.addText(SqlStatementBlocks.endGroup)},VisitUnaryExpression:function(a,
b){b.addText(a.resolution.mapTo);b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.operand,b);b.addText(SqlStatementBlocks.endGroup)},VisitSimpleBinaryExpression:function(a,b){b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.left,b);var c=this;b.addText(" "+a.resolution.mapTo+" ");if(a.nodeType=="in"){Guard.requireType("expression.right",a.right,$data.Expressions.ConstantExpression);var d=a.right.value;if(d instanceof Array){b.addText(SqlStatementBlocks.beginGroup);d.forEach(function(a,d){d>
0&&b.addText(SqlStatementBlocks.valueSeparator);var f=Container.createConstantExpression(a);c.Visit(f,b)});b.addText(SqlStatementBlocks.endGroup)}else d instanceof $data.Queryable?Guard.raise("not yet... but coming"):Guard.raise(new Exception("Only constant arrays and Queryables can be on the right side of 'in' operator","UnsupportedType"))}else this.Visit(a.right,b);b.addText(SqlStatementBlocks.endGroup)},VisitConstantExpression:function(a,b){b.addParameter(a.value);b.addText(SqlStatementBlocks.parameter)},
VisitEntityFieldExpression:function(a,b){if(a.source instanceof $data.Expressions.ComplexTypeExpression){var c=b.getExpressionAlias(a.source.source.source),d=a.source.source.storageModel.ComplexTypes[a.source.selector.memberName],e=d.ReferentialConstraint.filter(function(b){return b[a.source.selector.memberName]==a.selector.memberName})[0];if(e){b.addText(c);b.addText(SqlStatementBlocks.nameSeparator);b.addText(e[d.From])}else Guard.raise(new Exception("Compiler error! ComplexType does not contain "+
a.source.selector.memberName+" property!"))}else{this.Visit(a.source,b);this.Visit(a.selector,b)}},VisitEntitySetExpression:function(a,b){var c=b.getExpressionAlias(a);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator)},VisitComplexTypeExpression:function(a,b){var c=b.getExpressionAlias(a.source.source),d=a.source.storageModel.ComplexTypes[a.selector.memberName];d.ReferentialConstraint.forEach(function(a,g){g>0&&b.addText(SqlStatementBlocks.valueSeparator);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator);
b.addText(a[d.From]);b.addText(SqlStatementBlocks.as);b.addText(this.anonymFiledPrefix+a[d.To])},this)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},VisitObjectLiteralExpression:function(a,b){for(var c=a.members.length,d=0;d<c;d++){d!=0&&b.addText(SqlStatementBlocks.valueSeparator);this.Visit(a.members[d],b)}},MappedFullEntitySet:function(a,b){var c=b.getExpressionAlias(a);a.storageModel.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a,e){if(!a.association){e>
0&&b.addText(SqlStatementBlocks.valueSeparator);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator);b.addText(a.name);b.addText(SqlStatementBlocks.as);b.addText(this.anonymFiledPrefix+a.name)}},this)},VisitObjectFieldExpression:function(a,b){var c=this.currentObjectLiteralName;this.currentObjectLiteralName=this.currentObjectLiteralName?this.currentObjectLiteralName+("."+a.fieldName):a.fieldName;if(a.expression instanceof $data.Expressions.EntityExpression)this.VisitEntityExpressionAsProjection(a,
b);else{var d=this.anonymFiledPrefix;this.anonymFiledPrefix=this.anonymFiledPrefix+(a.fieldName+"__");a.expression instanceof $data.Expressions.EntitySetExpression?this.MappedFullEntitySet(a.expression,b):this.Visit(a.expression,b);this.anonymFiledPrefix=d;if(!(a.expression instanceof $data.Expressions.ObjectLiteralExpression)&&!(a.expression instanceof $data.Expressions.ComplexTypeExpression)&&!(a.expression instanceof $data.Expressions.EntitySetExpression)){b.addText(SqlStatementBlocks.as);b.addText(this.anonymFiledPrefix+
a.fieldName)}}this.currentObjectLiteralName=c}},null);
$C("$data.sqLite.SqlExpressionMonitor",$data.Expressions.ExpressionMonitor,null,{constructor:function(a){this.VisitIncludeExpression=function(b,c){var d=this.Visit(b.source,c);a.isMapped=true;var e=this.Visit(b.selector,c);a.isMapped=false;return d!==b.source||e!==b.selector?Container.createIncludeExpression(d,e):b};this.VisitProjectionExpression=function(b,c){var d=this.Visit(b.source,c);a.isMapped=true;var e=this.Visit(b.selector,c);a.isMapped=false;if(d!==b.source||e!==b.selector){d=Container.createProjectionExpression(d,
e,b.params,b.instance);d.projectionAs=b.projectionAs;return d}return b}}});
$C("$data.sqLite.SqlFilterCompiler",$data.Expressions.EntityExpressionVisitor,null,{VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.addText(a.resolution.mapTo);b.addText(SqlStatementBlocks.beginGroup);this.Visit(a.operand,b);b.addText(SqlStatementBlocks.endGroup)},VisitSimpleBinaryExpression:function(a,b){var c=this;if(a.nodeType=="arrayIndex")this.Visit(a.left,b);else{b.addText(SqlStatementBlocks.beginGroup);if(a.left instanceof $data.Expressions.EntityFieldExpression&&
a.right instanceof $data.Expressions.ConstantExpression&&a.right.value===null){this.Visit(a.left,b);b.addText(a.resolution.nullMap)}else if(a.right instanceof $data.Expressions.EntityFieldExpression&&a.left instanceof $data.Expressions.ConstantExpression&&a.left.value===null){this.Visit(a.right,b);b.addText(a.resolution.nullMap)}else{this.Visit(a.left,b);b.addText(" "+a.resolution.mapTo+" ");if(a.nodeType=="in"){Guard.requireType("expression.right",a.right,$data.Expressions.ConstantExpression);var d=
a.right.value;if(d instanceof Array){b.addText(SqlStatementBlocks.beginGroup);d.forEach(function(a,d){d>0&&b.addText(SqlStatementBlocks.valueSeparator);c.Visit(a,b)});b.addText(SqlStatementBlocks.endGroup)}else d instanceof $data.Queryable?b.addText("(SELECT d FROM ("+d.toTraceString().sqlText+"))"):Guard.raise(new Exception("Only constant arrays and Queryables can be on the right side of 'in' operator","UnsupportedType"))}else this.Visit(a.right,b)}b.addText(SqlStatementBlocks.endGroup)}},VisitEntitySetExpression:function(a,
b){var c=b.getExpressionAlias(a);b.addText(c);b.addText(SqlStatementBlocks.nameSeparator)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition,d=c.mapTo||c.name;b.addText(d);b.addText(SqlStatementBlocks.beginGroup);if(d==="like"){d=$data.sqLite.SqlBuilder.create([],b.entityContext);d.selectTextPart("fragment");this.Visit(a.parameters[0],d);d=d.getTextPart("fragment");d.params.forEach(function(a){var d=
c.parameters[0],a=d.prefix?d.prefix+a:a,a=d.suffix?a+d.suffix:a;b.addParameter(a)});b.addText(d.text);b.addText(" , ");this.Visit(a.source,b)}else{this.Visit(a.source,b);a.parameters.forEach(function(a){b.addText(" , ");this.Visit(a,b)},this)}b.addText(SqlStatementBlocks.endGroup)},VisitMemberInfoExpression:function(a,b){b.addText(a.memberName)},VisitQueryParameterExpression:function(a,b){var c=null,c=a.type=="array"?a.value[a.index]:a.value;b.addParameter(c);b.addText(SqlStatementBlocks.parameter)},
VisitConstantExpression:function(a,b){var c=b.entityContext.storageProvider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.type))](a.value);b.addParameter(c);b.addText(SqlStatementBlocks.parameter)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.addText("__")}});
$C("$data.sqLite.sqLite_ModelBinderCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this._query=a;this.sqlContext=b;this._sqlBuilder=$data.sqLite.SqlBuilder.create(b.sets,b.entityContext)},VisitSingleExpression:function(a){this._defaultModelBinder(a)},VisitSomeExpression:function(a){this._defaultModelBinder(a)},VisitFindExpression:function(a){this._defaultModelBinder(a)},VisitEveryExpression:function(a){this._defaultModelBinder(a)},VisitToArrayExpression:function(a){this._defaultModelBinder(a)},
VisitFirstExpression:function(a){this._defaultModelBinder(a)},VisitForEachExpression:function(a){this._defaultModelBinder(a)},VisitCountExpression:function(){var a=Container.createqueryBuilder();a.modelBinderConfig.$type=$data.Array;a.selectModelBinderProperty("$item");a.modelBinderConfig.$type=$data.Integer;a.modelBinderConfig.$source="cnt";a.resetModelBinderProperty();this._query.modelBinderConfig=a.modelBinderConfig},VisitExpression:function(a,b){var c=Container.createFindProjectionVisitor();c.Visit(a);
c.projectionExpression?this.Visit(c.projectionExpression,b):this.DefaultSelection(b)},_defaultModelBinder:function(a){var b=Container.createqueryBuilder();b.modelBinderConfig.$type=$data.Array;b.modelBinderConfig.$item={};b.selectModelBinderProperty("$item");this.VisitExpression(a,b);b.resetModelBinderProperty();this._query.modelBinderConfig=b.modelBinderConfig},_addPropertyToModelBinderConfig:function(a,b){var c=this._query.context._storageModel.getStorageModel(a);a.memberDefinitions.getPublicMappedProperties().forEach(function(a){if(!c||
c&&!c.Associations[a.name]&&!c.ComplexTypes[a.name]){a.key&&(this.currentObjectFieldName?b.addKeyField(this.currentObjectFieldName+"__"+a.name):b.addKeyField(a.name));b.modelBinderConfig[a.name]=this.currentObjectFieldName?this.currentObjectFieldName+"__"+a.name:a.name}},this);c&&this._addComplexTypeProperties(c.ComplexTypes,b)},_addComplexTypeProperties:function(a,b){a.forEach(function(a){b.selectModelBinderProperty(a.FromPropertyName);b.modelBinderConfig.$type=a.ToType;var d=this.currentObjectFieldName;
this.currentObjectFieldName=this.currentObjectFieldName?this.currentObjectFieldName+"__":"";this.currentObjectFieldName=this.currentObjectFieldName+a.FromPropertyName;this._addPropertyToModelBinderConfig(a.ToType,b);b.popModelBinderProperty();this.currentObjectFieldName=d},this)},DefaultSelection:function(a){a.modelBinderConfig.$type=this._query.defaultType;this._query.context._storageModel.getStorageModel(this._query.defaultType);if(this.sqlContext.infos.filter(function(a){return a.IsMapped}).length>
1)this.currentObjectFieldName=this._sqlBuilder.getExpressionAlias(this.sqlContext.sets[0]);this._addPropertyToModelBinderConfig(this._query.defaultType,a);this.sqlContext.infos.forEach(function(b,c){if(c>0&&b.IsMapped){var d=b.NavigationPath.split(".");d.shift();d.forEach(function(e,f){if(e)if(a.modelBinderConfig[e])a.selectModelBinderProperty(e);else{a.selectModelBinderProperty(e);var h=false;if(b.Association.associationInfo.ToMultiplicity==="*"&&d.length-1===f){a.modelBinderConfig.$type=$data.Array;
a.selectModelBinderProperty("$item");h=true}a.modelBinderConfig.$type=this.sqlContext.sets[c].elementType;this.currentObjectFieldName=this._sqlBuilder.getExpressionAlias(this.sqlContext.sets[c]);this._addPropertyToModelBinderConfig(this.sqlContext.sets[c].elementType,a);h&&a.popModelBinderProperty()}},this);for(var e=0;e<d.length;e++)a.popModelBinderProperty()}},this)},VisitProjectionExpression:function(a,b){this.hasProjection=true;this.Visit(a.selector,b);a.selector&&a.selector.expression instanceof
$data.Expressions.ObjectLiteralExpression&&(b.modelBinderConfig.$type=a.projectionAs||b.modelBinderConfig.$type||$data.Object)},VisitParametricQueryExpression:function(a,b){if(a.expression instanceof $data.Expressions.EntityExpression){this.VisitEntityAsProjection(a.expression,b);b.modelBinderConfig.$keys.unshift("rowid$$")}else if(a.expression instanceof $data.Expressions.EntitySetExpression){this.currentObjectFieldName=this._sqlBuilder.getExpressionAlias(a.expression);this.VisitEntitySetAsProjection(a.expression,
b);b.modelBinderConfig.$keys=["rowid$$"]}else if(a.expression instanceof $data.Expressions.ComplexTypeExpression)this.VisitEntityAsProjection(a.expression,b);else{b.modelBinderConfig.$keys=["rowid$$"];this.Visit(a.expression,b);a.expression instanceof $data.Expressions.EntityFieldExpression&&(b.modelBinderConfig.$source="d")}},VisitConstantExpression:function(a,b){b.modelBinderConfig.$type=a.type;b.modelBinderConfig.$source=this.currentObjectFieldName},VisitEntityAsProjection:function(a,b){this.Visit(a.source,
b);b.modelBinderConfig.$type=a.entityType;this._addPropertyToModelBinderConfig(a.entityType,b)},VisitEntitySetAsProjection:function(a,b){b.modelBinderConfig.$type=$data.Array;b.selectModelBinderProperty("$item");b.modelBinderConfig.$type=a.elementType;this._addPropertyToModelBinderConfig(a.elementType,b);b.popModelBinderProperty()},VisitComplexTypeExpression:function(a){return a},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,
b){if(a.memberDefinition instanceof $data.MemberDefinition){b.modelBinderConfig.$type=a.memberDefinition.type;a.memberDefinition.storageModel&&a.memberName in a.memberDefinition.storageModel.ComplexTypes?this._addPropertyToModelBinderConfig(Container.resolveType(a.memberDefinition.type),b):b.modelBinderConfig.$source=this.currentObjectFieldName}},VisitEntitySetExpression:function(a,b){if(a.source instanceof $data.Expressions.EntityExpression){this.Visit(a.source,b);this.Visit(a.selector,b)}},VisitEntityExpression:function(a,
b){this.Visit(a.source,b)},VisitAssociationInfoExpression:function(a,b){"$selector"in b.modelBinderConfig&&b.modelBinderConfig.$selector.length>0?b.modelBinderConfig.$selector=b.modelBinderConfig.$selector+".":b.modelBinderConfig.$selector="json:";b.modelBinderConfig.$selector=b.modelBinderConfig.$selector+a.associationInfo.FromPropertyName},VisitSimpleBinaryExpression:function(a,b){this.Visit(a.left,b);this.Visit(a.right,b);b.modelBinderConfig.$type=void 0},VisitObjectLiteralExpression:function(a,
b){b.modelBinderConfig.$type=$data.Object;a.members.forEach(function(a){this.Visit(a,b)},this)},VisitObjectFieldExpression:function(a,b){var c=this.currentObjectFieldName;b.selectModelBinderProperty(a.fieldName);this.currentObjectFieldName=this.currentObjectFieldName?this.currentObjectFieldName+"__":"";this.currentObjectFieldName=this.currentObjectFieldName+a.fieldName;a.expression instanceof $data.Expressions.EntityExpression||a.expression instanceof $data.Expressions.ComplexTypeExpression?this.VisitEntityAsProjection(a.expression,
b):a.expression instanceof $data.Expressions.EntitySetExpression?this.VisitEntitySetAsProjection(a.expression,b):this.Visit(a.expression,b);this.currentObjectFieldName=c;b.popModelBinderProperty()}});
